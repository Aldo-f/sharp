# Upgrading from 6.x to 7.x

Due to an extensive refactoring aiming to improve DX, there is many breaking changes in the API... But stay with me, it's mainly function renaming and new arguments. 

## Laravel 8+ and php 8.0+ required

It's not a BC, but still, minimal requirements are now these.

## Type hinting everywhere (part II)

In order to reinforce the API, we decided to use PHP type hinting everywhere. Sharp 6 handled the big part, but with php 8.0 we could add a few that were missing.

## EntityListQueryParams is now an instance property of an EntityList 

This means that the `getListData()` function no longer has a `$params` argument, which must be replaced by `$this->queryParams`. This change makes it much easier to build the EntityList depending on the request (hide some columns for instance). 

## DashboardQueryParams is now an instance property of a Dashboard

Similarly, the `buildWidgetsData()` function no longer has a `$params` argument, which must be replaced by `$this->queryParams`.

## All configuration methods have now a name prefixed with `configure...`

The motivation for this was to provide a clear list of available methods for configuration to the developer. This could lead to many changes, but it's quite easy to fix them. Here's the full list of renamed methods:

Renamed methods of `SharpEntityList`:
- `setInstanceIdAttribute()` -> `configureInstanceIdAttribute()`
- `setSearchable()` -> `configureSearchable()`
- `setDefaultSort()` -> `configureDefaultSort()`
- `setPaginated()` -> `configurePaginated()`

Renamed methods of `SharpForm`:
- `setDisplayShowPageAfterCreation()` -> `configureDisplayShowPageAfterCreation()`
- `setDisplayShowPageAfterCreation()` -> `configureBreadcrumbCustomLabelAttribute()`

Renamed methods of `SharpShow`:
- `setMultiformAttribute()` -> `configureMultiformAttribute()`
- `setEntityState()` -> `configureEntityState()`
- `setBreadcrumbCustomLabelAttribute()` -> `configureBreadcrumbCustomLabelAttribute()`

Renamed methods of `Command`:
- `setConfirmationText()` -> `configureConfirmationText()`
- `setDescription()` -> `configureDescription()`
- `setFormModalTitle()` -> `configureFormModalTitle()`

## Add proxy objects for EntityList columns and layout

The idea is to provide dedicated objects when needed to clearly indicate the API to the developer.

### `buildListDataContainers()` is renamed to `buildListFields(EntityListFieldsContainer $fieldsContainer)`

The `$fieldsContainer` parameter is a proxy object with the needed `->addField(...)` function.
As a bonus, `EntityListDataContainer` was renamed `EntityListField` for clarity.

Example: you need to refactor you code from this:

```php
function buildListDataContainers(): void
{
    $this
        ->addDataContainer(
            EntityListDataContainer::make("name")
                ->setLabel("Name")
        )
        ->addField(
            EntityListDataContainer::make("age")
                ->setLabel("Age")
        );
}
```

To this:

```php
function buildListFields(EntityListFieldsContainer $fieldsContainer): void
{
    $fieldsContainer
        ->addField(
            EntityListField::make("name")
                ->setLabel("Name")
        )
        ->addField(
            EntityListField::make("age")
                ->setLabel("Age")
        );
}
```

### `buildListLayout()` signature has changed to `buildListLayout(EntityListFieldsLayout $fieldsLayout)`

The `$fieldsLayout` parameter is a proxy object with the needed `->addColumn(...)` function.

Example: you need to refactor you code from this:

```php
function buildListLayout(): void
{
    $this->addColumn("picture", 1)
        ->addColumn("name", 2)
        ->addColumn("capacity", 2)
        ->addColumn("type:label", 2)
        ->addColumn("pilots")
        ->addColumn("messages_sent_count");
}
```

To this:

```php
function buildListLayout(EntityListFieldsLayout $fieldsLayout): void
{
    $fieldsLayout->addColumn("picture", 1)
        ->addColumn("name", 2)
        ->addColumn("capacity", 2)
        ->addColumn("type:label", 2)
        ->addColumn("pilots")
        ->addColumn("messages_sent_count");
}
```

### EntityList's `->addColumn()` no longer has optional parameter for small screens

Instead, a new optional `buildListLayoutForSmallScreens()` is available. [Refer to doc](../building-entity-list) for details.

## Add proxy objects for Form fields and layout

### `buildFormFields()` is renamed to `buildFormFields(FieldsContainer $formFields)`

The `$formFields` parameter is a proxy object with the needed `->addField(...)` function.

Example: you need to refactor you code from this:

```php
function buildFormFields(): void
{
    $this
        ->addField(
            SharpFormTextField::make("name")
                ->setLabel("Name")
        );
}
```

To this:

```php
function buildFormFields(FieldsContainer $formFields): void
{
    $formFields
        ->addField(
            SharpFormTextField::make("name")
                ->setLabel("Name")
        );
}
```

### `buildFormLayout()` signature has changed to `buildFormLayout(FormLayout $formLayout)`

The `$formLayout` parameter is a proxy object with the needed `->addTab(...)` and `->addColumn(...)` functions.

Example: you need to refactor you code from this:

```php
function buildFormLayout(): void
{
    $this
        ->addColumn(6, function(FormLayoutColumn $column) {
            return $column->withSingleField("name")
                ->withSingleField("email");
        });
}
```

To this:

```php
function buildFormLayout(FormLayout $formLayout): void
{
    $formLayout
        ->addColumn(6, function(FormLayoutColumn $column) {
            return $column->withSingleField("name")
                ->withSingleField("email");
        });
}
```

## Add proxy objects for Show fields and layout

### `buildShowFields()` is renamed to `buildShowFields(FieldsContainer $showFields)`

The `$showFields` parameter is a proxy object with the needed `->addField(...)` function.

Example: you need to refactor you code from this:

```php
function buildShowFields(): void
{
    $this
        ->addField(
            SharpShowTextField::make("name")
                ->setLabel("Name")
        );
}
```

To this:

```php
function buildShowFields(FieldsContainer $showFields): void
{
    $showFields
        ->addField(
            SharpShowTextField::make("name")
                ->setLabel("Name")
        );
}
```

### `buildShowLayout()` signature has changed to `buildShowLayout(ShowLayout $showLayout)`

The `$showLayout` parameter is a proxy object with the needed `->addSection(...)` and `->addEntityListSection(...)` functions.

Example: you need to refactor you code from this:

```php
function buildShowLayout(): void
{
    $this
        ->addSection("Identity", function(ShowLayoutSection $section) {
            $section
                ->addColumn(6, function(ShowLayoutColumn $column) {
                    $column->withSingleField("name");
                });
        });
}
```

To this:

```php
function buildShowLayout(ShowLayout $showLayout): void
{
    $showLayout
        ->addSection("Identity", function(ShowLayoutSection $section) {
            $section
                ->addColumn(6, function(ShowLayoutColumn $column) {
                    $column->withSingleField("name");
                });
        });
}
```

## API changes on Commands

There are various changes on Commands, but it's mainly code reorganization and function renaming, for better clarity and easier configuration.

### New Command declaration

Commands must now be declared in dedicated function: `getInstanceCommands()` (EntityList and Show Page), `getEntityCommands()` (EntityList),  and `getDashboardCommands()` (Dashboard) â€” previously they were declared in the `build...Config()` method.

For example, here's a 6.0 EntityList (everything in the `buildListConfig()` function):

```php
function buildListConfig(): void
{
    $this->setInstanceIdAttribute("id")
        ->setSearchable()
        ->setDefaultSort("name", "asc")
        ->addFilter("type", SpaceshipTypeFilter::class)
        ->addFilter("pilots", SpaceshipPilotsFilter::class)
        ->addEntityCommand("synchronize", SpaceshipSynchronize::class)
        ->addEntityCommand("reload", SpaceshipReload::class)
        ->addInstanceCommand("message", SpaceshipSendMessage::class)
        ->addInstanceCommand("preview", SpaceshipPreview::class)
        ->addInstanceCommandSeparator()
        ->addInstanceCommand("external", SpaceshipExternalLink::class);
}
```

And the same EntityList in 7.0: Commands are no longer in the `buildListConfig` function:

```php
function getEntityCommands(): ?array
{
    return [
        "synchronize" => new SpaceshipSynchronize(),
        SpaceshipReload::class
    ];
}

function getInstanceCommands(): ?array
{
    return [
        SpaceshipSendMessage::class,
        new SpaceshipPreview(),
        "---",
        SpaceshipExternalLink::class
    ];
}

function buildListConfig(): void
{
    $this->configureInstanceIdAttribute("id")
        ->configureSearchable()
        ->configureDefaultSort("name", "asc");
}
```

Also notice that:
- the Command key is now optional
- the Command separator is a string made of dashes (one is enough)
- Filters were removed as well, see dedicated section below in this guide

**This applies in every class that leverage Commands: EntityList, Show Page and Dashboard.**

### new `buildCommandConfig()` method + removal of old functions: `->description()`, `->confirmationText()`...

In 6.0, some Command configuration was done overriding some methods, without really knowing which ones are concerned. In 7.0, a new  `buildCommandConfig()` is here to handle all configuration.

Here's a 6.0 example:

```php
class TravelSendEmail extends InstanceCommand
{
    public function label(): string
    {
        return "Send email";
    }

    public function formModalTitle(): string
    {
        return "Send email";
    }

    public function description(): string
    {
        return "Will pretend to send an email to all the passengers of this flight.";
    }
    
    [...]
}
```

And its 7.0 version:

```php
class class TravelSendEmail extends InstanceCommand
{
    public function label(): string
    {
        return "Send email";
    }
    
    public function buildCommandConfig(): void
    {
        $this->configureFormModalTitle("Send email")
            ->configureDescription("Will pretend to send an email to all the passengers of this flight.");
    }
    
    [...]
}
```

### New proxy object for form building

Exactly like for SharpForm (see above), you need to go from this in 6.0: 

```php
public function buildFormFields(): void
{
    $this
        ->addField(
            SharpFormTextField::make("subject")
                ->setLabel("Subject")
    );
}
```

To this in 7.0:

```php
public function buildFormFields(FieldsContainer $formFields): void
{
    $formFields
        ->addField(
            SharpFormTextField::make("subject")
                ->setLabel("Subject")
    );
}
```

## Changes on Filters

### Base Filters are no longer interfaces, but abstract classes

... so you need to change all `implements SelectFilter` (for instance) to `extends SelectFilter`.

### New Filter declaration

Similar to Commands, Filters must now be declared in dedicated function: `getFilters()`.

For example, here's a 6.0 EntityList (everything in the `buildListConfig()` function):

```php
function buildListConfig(): void
{
    $this->setInstanceIdAttribute("id")
        ->setSearchable()
        ->setDefaultSort("name", "asc")
        ->addFilter("type", SpaceshipTypeFilter::class)
        ->addFilter("pilots", SpaceshipPilotsFilter::class);
}
```

To this:

```php
function getFilters(): ?array
{
    return [
        SpaceshipTypeFilter::class,
        new SpaceshipPilotsFilter() // Filters can be declared as class name or instances 
    ];
}

function buildListConfig(): void
{
    $this->configureInstanceIdAttribute("id")
        ->configureSearchable()
        ->configureDefaultSort("name", "asc");
}
```

Also notice that the Filter keys (type and pilots, in this example) disappeared

**This applies in all classes that leverage Filters: EntityList and Dashboard.**

### No more filter key: update your queries

Like seen in the previous point, the string key has been removed for simplicity and to avoid mistakes. So in Sharp 7.0, to extract a filter value from the query params, you'll need to provide the filter's class name.

For example:

```php
function getListData(): array|Arrayable
{
    $pilot = $this->queryParams->filterFor(SpaceshipPilotFilter::class);
    [...]
}
```

### New `buildFilterConfig()` method + removal of all old functions: `->isSearchable()`, `->isMaster()`, `->template()`...

Like other classes in Sharp, Filters now have a dedicated `buildFilterConfig()` method to group all configuration calls. And since we moved from interfaces to abstract classes, it's easier to find all available options with IDE autocompletion: all option methods start with `configure[...]()`.

For example:

```php
public function buildFilterConfig(): void
{
    $this->configureLabel("Ship type")
        ->configureSearchable()
        ->configureRetainInSession();
}
```

### Changes on global filters configuration

Global filters no longer need keys (in the configuration, where they are declared):

```php
// in config/sharp.php

return [
    [...],
    "global_filters" => [
        CorporationGlobalFilter::class,
    ]
];
```

Also update your queries accordingly, using full class name instead of key, like for other fields:

```php
function getListData(): array|Arrayable
{
    $spaceships = Spaceship::select("spaceships.*")
        ->where("corporation_id", currentSharpRequest()->globalFilterFor(CorporationGlobalFilter::class))
        ->get();
    [...]
}
```

### The `callback()` filter feature was removed

This feature wasn't well designed. It may be replaced in the future is needed.

## Changes on testing

### Commands could be called via class name

TODO